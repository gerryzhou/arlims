<form [formGroup]="form">

   <div class="sampling-method area">

      <span>
         <span class="methods-title">Sampling method</span>
         <ng-container *ngIf="allowDataChanges">
            <mat-menu #samplingMethodMenu="matMenu">
               <span class="methods-section-header" *ngIf="sampleMethodChoicesByTestUnitType.compsMethods.length > 0">
                  Composite Methods
               </span>

               <button mat-menu-item *ngFor="let samplingMethod of sampleMethodChoicesByTestUnitType.compsMethods"
                       (click)="onSamplingMethodClicked(samplingMethod)">
                  {{samplingMethod.description}}
               </button>

               <mat-divider></mat-divider>

               <span class="methods-section-header" *ngIf="sampleMethodChoicesByTestUnitType.subsMethods.length > 0">
                  Subsample Methods
               </span>

               <button mat-menu-item *ngFor="let samplingMethod of sampleMethodChoicesByTestUnitType.subsMethods"
                       (click)="onSamplingMethodClicked(samplingMethod)">
                  {{samplingMethod.description}}
               </button>

               <span class="methods-section-header">Manual Entry Methods</span>

               <button mat-menu-item (click)="onManualEntrySamplingMethodSelected('composite')">
                  Enter composites method numbers manually
               </button>

               <button mat-menu-item (click)="onManualEntrySamplingMethodSelected('subsample')">
                  Enter subsamples method numbers manually
               </button>
            </mat-menu>
            <button mat-button [matMenuTriggerFor]="samplingMethodMenu">
               Select a sampling method <mat-icon>more_vert</mat-icon>
            </button>
         </ng-container>
      </span>

      <div formGroupName="samplingMethod"
         class="method-numbers"
         *ngIf="form.get(['samplingMethod', 'testUnitsType']).value">

         <button mat-icon-button *ngIf="allowDataChanges"
                 (click)="onToggleSamplingMethodManualEntry()">
            <mat-icon class="user-modifiable-icon">
               {{form.get(['samplingMethod', 'userModifiable']).value === true ? 'lock_open' : 'lock'}}
            </mat-icon>
         </button>

         <div class="field-area" *ngIf="form.get(['samplingMethod', 'userModifiable']).value; else subsCompsReadOnly"
              [class.conflicted]="conflicts.samplingMethod && conflicts.samplingMethod.testUnitsType !== undefined">
            <mat-radio-group formControlName="testUnitsType">
               <div>Examining:</div>
               <div>
                  <mat-radio-button [value]="'subsample'">
                     subs
                  </mat-radio-button>
                  <mat-radio-button [value]="'composite'">
                     composites
                  </mat-radio-button>
                  <mat-radio-button *ngIf="showUnsetAffordances" [value]="null" class="unset">
                     unset
                  </mat-radio-button>
               </div>
            </mat-radio-group>
            <app-conflicting-field-value
               [conflictValue]="conflicts.samplingMethod.testUnitsType"
               [conflictWhoWhen]="conflictsWhoWhen"
               (dismiss)="conflicts.samplingMethod.testUnitsType = undefined">
            </app-conflicting-field-value>
         </div>
         <ng-template #subsCompsReadOnly>
            <div class="test-units-type-ro">Examining: <b>{{testUnitsTypeDescr}}</b></div>
         </ng-template>

         <div class="field-area"
              [class.conflicted]="conflicts.samplingMethod && conflicts.samplingMethod.testUnitsCount !== undefined">
            <mat-form-field>
               <input formControlName="testUnitsCount" type="number" min="0" step="1" matInput
                  [readonly]="!form.get(['samplingMethod', 'userModifiable']).value"
                  [placeholder]="'Examined ' + testUnitsTypeDescr">
            </mat-form-field>
            <app-conflicting-field-value *ngIf="conflicts.samplingMethod"
               [conflictValue]="conflicts.samplingMethod.testUnitsCount"
               [conflictWhoWhen]="conflictsWhoWhen"
               (dismiss)="conflicts.samplingMethod.testUnitsCount = undefined">
            </app-conflicting-field-value>
         </div>

         <div class="field-area" *ngIf="form.get(['samplingMethod', 'testUnitsType']).value === 'composite'"
              [class.conflicted]="conflicts.samplingMethod && conflicts.samplingMethod.numberOfSubsPerComposite !== undefined">
            <mat-form-field>
               <input formControlName="numberOfSubsPerComposite" type="number" min="0" step="1" matInput
                      [readonly]="!form.get(['samplingMethod', 'userModifiable']).value"
                      placeholder="Subs per comp">
            </mat-form-field>
            <app-conflicting-field-value *ngIf="conflicts.samplingMethod"
               [conflictValue]="conflicts.samplingMethod.numberOfSubsPerComposite"
               [conflictWhoWhen]="conflictsWhoWhen"
               (dismiss)="conflicts.samplingMethod.numberOfSubsPerComposite = undefined">
            </app-conflicting-field-value>
         </div>

         <div class="field-area"
              [class.conflicted]="conflicts.samplingMethod && conflicts.samplingMethod.extractedGramsPerSub !== undefined">
            <mat-form-field>
               <input formControlName="extractedGramsPerSub" type="number" min="0" step="1" matInput
                  [readonly]="!form.get(['samplingMethod', 'userModifiable']).value"
                  placeholder="Extracted grams per sub">
            </mat-form-field>
            <app-conflicting-field-value *ngIf="conflicts.samplingMethod"
               [conflictValue]="conflicts.samplingMethod.extractedGramsPerSub"
               [conflictWhoWhen]="conflictsWhoWhen"
               (dismiss)="conflicts.samplingMethod.extractedGramsPerSub = undefined">
            </app-conflicting-field-value>
         </div>

      </div> <!-- sampling method numbers -->

      <div class="field-area method-exceptions" *ngIf="form.get(['samplingMethod', 'testUnitsType']).value"
           [class.conflicted]="conflicts.samplingMethodExceptionsNotes !== undefined">
         <mat-form-field>
            <input formControlName="samplingMethodExceptionsNotes" type="text" matInput
               placeholder="Sampling method exceptions">
         </mat-form-field>
         <app-conflicting-field-value
            [conflictValue]="conflicts.samplingMethodExceptionsNotes"
            [conflictWhoWhen]="conflictsWhoWhen"
            (dismiss)="conflicts.samplingMethodExceptionsNotes = undefined">
         </app-conflicting-field-value>
      </div>

   </div> <!-- sampling method form group -->


   <div class="row area">

      <div class="field-area" [class.conflicted]="conflicts.balanceId !== undefined">
         <span>
            <mat-form-field>
               <mat-select formControlName="balanceId" placeholder="Balance"
                  *ngIf="balances && selectBalance; else textInputBalance">
                  <mat-option [value]="null"></mat-option>
                  <mat-option *ngFor="let labRsc of balances" [value]="labRsc.code">
                     {{labRsc.code}}{{labRsc.description ? ' - ' + labRsc.description : ''}}
                  </mat-option>
               </mat-select>
               <ng-template #textInputBalance>
                  <input formControlName="balanceId" type="text" matInput placeholder="Balance">
               </ng-template>
            </mat-form-field>
            <button class="toggle-select" *ngIf="balances && allowDataChanges && allowTogglingSelects"
               (click)="toggleSelectBalance()"
               mat-icon-button matTooltip="toggle between a select list and free-from text entry">
               <mat-icon>create</mat-icon>
            </button>
         </span>
         <app-conflicting-field-value
            [conflictValue]="conflicts.balanceId"
            [conflictWhoWhen]="conflictsWhoWhen"
            (dismiss)="conflicts.balanceId = undefined">
         </app-conflicting-field-value>
      </div>

      <div class="field-area"
           [class.conflicted]="conflicts.blenderJarId !== undefined"
           [class.batch-resource-matched]="resourceAssignments.hasAssignedOrAppliedResources('blenderJarId')">
         <mat-form-field>
            <input formControlName="blenderJarId" type="text" matInput placeholder="Blender jar">
         </mat-form-field>
         <app-field-assigned-resources *ngIf="allowDataChanges"
            [resourceCodes]="resourceAssignments.getAssignedResourceCodesForControl('blenderJarId')"
            (select)="resourceAssignments.applyAssignedResourceToControl($event, 'blenderJarId')"
            (remove)="resourceAssignments.removeAssignedResourceCodeForControl($event, 'blenderJarId')"
            (removeAll)="resourceAssignments.removeAllResourceAssignmentsForControl('blenderJarId')">
         </app-field-assigned-resources>
         <app-conflicting-field-value
            [conflictValue]="conflicts.blenderJarId"
            [conflictWhoWhen]="conflictsWhoWhen"
            (dismiss)="conflicts.blenderJarId = undefined">
         </app-conflicting-field-value>

      </div>

      <div class="field-area"
           [class.conflicted]="conflicts.bagId !== undefined"
           [class.batch-resource-matched]="resourceAssignments.hasAssignedOrAppliedResources('bagId')">
         <mat-form-field>
            <input formControlName="bagId" type="text" matInput placeholder="Bag">
         </mat-form-field>
         <app-field-assigned-resources *ngIf="allowDataChanges"
            [resourceCodes]="resourceAssignments.getAssignedResourceCodesForControl('bagId')"
            (select)="resourceAssignments.applyAssignedResourceToControl($event, 'bagId')"
            (remove)="resourceAssignments.removeAssignedResourceCodeForControl($event, 'bagId')"
            (removeAll)="resourceAssignments.removeAllResourceAssignmentsForControl('bagId')">
         </app-field-assigned-resources>
         <app-conflicting-field-value
            [conflictValue]="conflicts.bagId"
            [conflictWhoWhen]="conflictsWhoWhen"
            (dismiss)="conflicts.bagId = undefined">
         </app-conflicting-field-value>

      </div>

      <div class="field-area"
           [class.conflicted]="conflicts.mediumBatchId !== undefined"
           [class.batch-resource-matched]="resourceAssignments.hasAssignedOrAppliedResources('mediumBatchId')">
         <mat-form-field>
            <input formControlName="mediumBatchId" type="text" matInput placeholder="Medium batch">
         </mat-form-field>
         <app-field-assigned-resources *ngIf="allowDataChanges"
            [resourceCodes]="resourceAssignments.getAssignedResourceCodesForControl('mediumBatchId')"
            (select)="resourceAssignments.applyAssignedResourceToControl($event, 'mediumBatchId')"
            (remove)="resourceAssignments.removeAssignedResourceCodeForControl($event, 'mediumBatchId')"
            (removeAll)="resourceAssignments.removeAllResourceAssignmentsForControl('mediumBatchId')">
         </app-field-assigned-resources>
         <app-conflicting-field-value
            [conflictValue]="conflicts.mediumBatchId"
            [conflictWhoWhen]="conflictsWhoWhen"
            (dismiss)="conflicts.mediumBatchId = undefined">
         </app-conflicting-field-value>
      </div>

      <div class="field-area medium-type"
           [class.conflicted]="conflicts.mediumType !== undefined"
           [class.batch-resource-matched]="resourceAssignments.hasAssignedOrAppliedResources('mediumType')">
         <mat-form-field>
            <input formControlName="mediumType" type="text" matInput placeholder="Medium type">
         </mat-form-field>
         <app-conflicting-field-value
            [conflictValue]="conflicts.mediumType"
            [conflictWhoWhen]="conflictsWhoWhen"
            (dismiss)="conflicts.mediumType = undefined">
         </app-conflicting-field-value>
      </div>
      <div class="medium-type-predefined-inputs">
         <button class="link" (click)="form.get('mediumType').setValue('Lactose');" *ngIf="allowDataChanges">
            Lactose
         </button>
         <button class="link" (click)="form.get('mediumType').setValue('TSB');" *ngIf="allowDataChanges">
            TSB
         </button>
      </div>

      <div class="field-area" [class.conflicted]="conflicts.incubatorId !== undefined">
         <span>
            <mat-form-field>
               <mat-select formControlName="incubatorId" placeholder="Incubator"
                           *ngIf="incubators && selectIncubator; else textInputIncubator">
                  <mat-option [value]="null"></mat-option>
                  <mat-option *ngFor="let labRsc of incubators" [value]="labRsc.code">
                     {{labRsc.code}}{{labRsc.description ? ' - ' + labRsc.description : ''}}
                  </mat-option>
               </mat-select>
               <ng-template #textInputIncubator>
                  <input formControlName="incubatorId" type="text" matInput placeholder="Incubator">
               </ng-template>
            </mat-form-field>
            <button *ngIf="incubators && allowDataChanges && allowTogglingSelects"
                    (click)="toggleSelectIncubator()"
                    mat-icon-button matTooltip="toggle between a select list and free-from text entry">
               <mat-icon>create</mat-icon>
            </button>
         </span>
         <app-conflicting-field-value
            [conflictValue]="conflicts.incubatorId"
            [conflictWhoWhen]="conflictsWhoWhen"
            (dismiss)="conflicts.incubatorId = undefined">
         </app-conflicting-field-value>
      </div>

      <button class="apply-resources-btn"  *ngIf="allowDataChanges"
              (click)="promptApplyResources()"
              mat-icon-button color="accent">
         <mat-icon>flash_on</mat-icon>
      </button>

   </div> <!-- resource-identifiers  -->


   <div class="area">
      <div class="field-area" [class.conflicted]="conflicts.sampleSpike !== undefined">
         <mat-radio-group formControlName="sampleSpike">
            <div>Sample spiking</div>
            <div>
               <mat-radio-button [value]="true">Y</mat-radio-button>
               <mat-radio-button [value]="false">N</mat-radio-button>
               <mat-radio-button *ngIf="showUnsetAffordances" [value]="null" class="unset">unset</mat-radio-button>
            </div>
         </mat-radio-group>
         <app-conflicting-field-value
            [conflictValue]="conflicts.sampleSpike"
            [conflictWhoWhen]="conflictsWhoWhen"
            (dismiss)="conflicts.sampleSpike = undefined">
         </app-conflicting-field-value>
      </div>
   </div> <!-- spiking -->

</form>

